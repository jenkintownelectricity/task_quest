<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task Quest | Armand's Adventure</title>
    <meta name="theme-color" content="#6366f1">
    <meta name="description" content="ADHD-optimized task tracker. Complete quests, earn XP, unlock achievements!">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --secondary: #8b5cf6; --success: #22c55e; --warning: #f59e0b; --xp: #3b82f6; --coins: #eab308; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .task-card { transition: all 0.2s; cursor: pointer; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .task-card.done { opacity: 0.5; background: #f0fdf4; }
        .xp-bar { background: linear-gradient(90deg, var(--xp), var(--secondary)); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--secondary); transform: scale(1.02); }
        .tab { padding: 0.75rem 1rem; border-bottom: 3px solid transparent; cursor: pointer; }
        .tab.active { border-color: var(--primary); color: var(--primary); }
        .streak-fire { animation: flicker 0.5s infinite alternate; }
        @keyframes flicker { from { opacity: 0.8; } to { opacity: 1; } }
        @keyframes confetti-fall { 0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .confetti { position: fixed; top: -10px; font-size: 24px; animation: confetti-fall 3s linear forwards; pointer-events: none; z-index: 9999; }
        .screen-time-glow { text-shadow: 0 0 10px rgba(34, 197, 94, 0.8); }
        .hero-task { border-left: 4px solid #8b5cf6; background: linear-gradient(90deg, rgba(139,92,246,0.1) 0%, transparent 100%); }
        .legendary-task { border-left: 4px solid #eab308; background: linear-gradient(90deg, rgba(234,179,8,0.15) 0%, transparent 100%); }
        .bonus-badge { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        /* Timer Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: 1.5rem; padding: 2rem; max-width: 90%; width: 400px; text-align: center; }
        .timer-display { font-size: 4rem; font-weight: bold; color: var(--primary); font-family: monospace; }
        @keyframes timer-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .timer-active { animation: timer-pulse 1s infinite; }
        /* Identity System */
        .setup-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .setup-card { background: white; border-radius: 2rem; padding: 2rem; max-width: 95%; width: 450px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        .avatar-picker { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
        .avatar-option { width: 50px; height: 50px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .avatar-option:hover, .avatar-option.selected { border-color: var(--primary); transform: scale(1.1); }
        .role-option { padding: 1rem; border: 2px solid #e5e7eb; border-radius: 1rem; cursor: pointer; transition: all 0.2s; }
        .role-option:hover, .role-option.selected { border-color: var(--primary); background: #f0f0ff; }
        .invite-code { font-family: monospace; font-size: 2rem; letter-spacing: 0.5rem; padding: 1rem; background: #f3f4f6; border-radius: 1rem; }
        .child-switcher { display: flex; gap: 0.5rem; overflow-x: auto; padding: 0.5rem 0; }
        .child-pill { padding: 0.5rem 1rem; border-radius: 2rem; background: white/20; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .child-pill.active { background: white; color: var(--primary); }
        .care-team-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
<div id="app">
    <!-- HEADER -->
    <header class="gradient-bg text-white p-4 sticky top-0 z-40">
        <div class="max-w-2xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div id="hero-avatar" class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-2xl cursor-pointer hover:bg-white/30 transition-all" onclick="openChildSelectorModal()">
                    üêâ
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <h1 id="hero-name" class="font-bold text-lg">Armand</h1>
                        <span id="role-badge" class="text-xs bg-white/20 px-2 py-0.5 rounded-full hidden"></span>
                    </div>
                    <div class="text-sm opacity-90">
                        <span id="hero-level">Level 1</span> ‚Ä¢ <span id="hero-title">Beginner</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3 text-center">
                <div class="bg-green-500/30 rounded-lg px-2 py-1">
                    <div class="text-xl font-bold screen-time-glow" id="hero-screentime">0</div>
                    <div class="text-xs opacity-90"><i class="fas fa-tv"></i> min</div>
                </div>
                <div>
                    <div class="text-lg font-bold" id="hero-coins">0</div>
                    <div class="text-xs opacity-75"><i class="fas fa-coins text-yellow-300"></i></div>
                </div>
                <div>
                    <div class="text-lg font-bold streak-fire" id="hero-streak">0</div>
                    <div class="text-xs opacity-75"><i class="fas fa-fire text-orange-400"></i></div>
                </div>
                <div id="care-team-btn" class="bg-white/20 rounded-lg px-2 py-1 cursor-pointer hover:bg-white/30 transition-all hidden" onclick="openCareTeamModal()">
                    <div class="text-lg"><i class="fas fa-users"></i></div>
                    <div class="text-xs opacity-75">Team</div>
                </div>
            </div>
        </div>
        <!-- XP BAR -->
        <div class="max-w-2xl mx-auto mt-3">
            <div class="flex justify-between text-xs mb-1">
                <span id="xp-current">0 XP</span>
                <span id="xp-next">100 XP to Level 2</span>
            </div>
            <div class="bg-white/20 rounded-full h-3 overflow-hidden">
                <div id="xp-bar" class="xp-bar h-full rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </header>

    <!-- NAV TABS -->
    <nav class="bg-white shadow-sm sticky top-32 z-30">
        <div class="max-w-2xl mx-auto flex">
            <button class="tab active flex-1" data-tab="tasks" onclick="showTab('tasks')"><i class="fas fa-tasks mr-1"></i> Tasks</button>
            <button class="tab flex-1" data-tab="shop" onclick="showTab('shop')"><i class="fas fa-store mr-1"></i> Shop</button>
            <button class="tab flex-1" data-tab="badges" onclick="showTab('badges')"><i class="fas fa-medal mr-1"></i> Badges</button>
            <button class="tab flex-1" data-tab="journey" onclick="showTab('journey')"><i class="fas fa-map mr-1"></i> Map</button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="max-w-2xl mx-auto p-4 pb-24">
        <!-- TASKS TAB -->
        <section id="tab-tasks">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Today's Quests</h2>
                <span id="tasks-progress" class="text-sm text-gray-500">0/0 Complete</span>
            </div>
            <div id="task-list" class="space-y-3"></div>
        </section>

        <!-- SHOP TAB -->
        <section id="tab-shop" class="hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Reward Shop</h2>
            <div id="shop-list" class="grid gap-3"></div>
        </section>

        <!-- BADGES TAB -->
        <section id="tab-badges" class="hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Achievements</h2>
            <div id="badge-list" class="grid grid-cols-2 gap-3"></div>
        </section>

        <!-- JOURNEY TAB -->
        <section id="tab-journey" class="hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Journey Map</h2>
            <div id="journey-list" class="space-y-4"></div>
        </section>
    </main>

    <!-- TIMER MODAL -->
    <div class="modal-overlay" id="timer-modal">
        <div class="modal-content">
            <div class="text-gray-500 text-sm mb-2">TASK TIMER</div>
            <div class="timer-display" id="timer-display">5:00</div>
            <div class="text-lg font-semibold text-gray-700 mt-2" id="timer-task-name">Task Name</div>
            <div class="text-sm text-gray-500 mb-4" id="timer-xp-preview">+0 XP ‚Ä¢ +0 min screen time</div>
            <div class="flex gap-3 justify-center">
                <button onclick="Timer.cancel()" class="btn bg-gray-200 text-gray-700">Cancel</button>
                <button onclick="Timer.complete()" class="btn btn-primary"><i class="fas fa-check mr-1"></i> Done!</button>
            </div>
        </div>
    </div>

    <!-- SCREEN TIME REDEEM MODAL -->
    <div class="modal-overlay" id="redeem-modal">
        <div class="modal-content">
            <div class="text-5xl mb-4">üì∫</div>
            <h3 class="text-xl font-bold text-gray-800">Redeem Screen Time</h3>
            <div class="text-4xl font-bold text-green-500 my-4" id="redeem-amount">0 min</div>
            <p class="text-gray-500 mb-4">Show this to Mom or Dad to start your screen time!</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeRedeemModal()" class="btn bg-gray-200 text-gray-700">Cancel</button>
                <button onclick="useScreenTime()" class="btn bg-green-500 text-white"><i class="fas fa-play mr-1"></i> Start Timer</button>
            </div>
        </div>
    </div>

    <!-- SETUP WIZARD (First Time) -->
    <div class="setup-screen hidden" id="setup-screen">
        <div class="setup-card">
            <!-- Step 1: Choose Role -->
            <div id="setup-step-1">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">üè∞</div>
                    <h2 class="text-2xl font-bold text-gray-800">Welcome to Task Quest!</h2>
                    <p class="text-gray-500">Who's joining the adventure?</p>
                </div>
                <div class="space-y-3">
                    <div class="role-option" onclick="Identity.selectRole('child')">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üßí</span>
                            <div>
                                <div class="font-bold">I'm a Kid</div>
                                <div class="text-sm text-gray-500">Ready to complete quests and earn rewards!</div>
                            </div>
                        </div>
                    </div>
                    <div class="role-option" onclick="Identity.selectRole('guardian_primary')">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üë®‚Äçüë©‚Äçüëß</span>
                            <div>
                                <div class="font-bold">I'm a Parent/Guardian</div>
                                <div class="text-sm text-gray-500">Setting up for my child</div>
                            </div>
                        </div>
                    </div>
                    <div class="role-option" onclick="Identity.selectRole('caregiver')">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">ü§ù</span>
                            <div>
                                <div class="font-bold">I'm Part of the Care Team</div>
                                <div class="text-sm text-gray-500">Teacher, therapist, family member (I have an invite code)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Child Setup -->
            <div id="setup-step-2" class="hidden">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">‚öîÔ∏è</div>
                    <h2 class="text-2xl font-bold text-gray-800">Create Your Hero</h2>
                    <p class="text-gray-500">What should we call you?</p>
                </div>
                <div class="space-y-4">
                    <input type="text" id="child-name-input" placeholder="Enter name..."
                           class="w-full p-4 border-2 border-gray-200 rounded-xl text-lg focus:border-purple-500 outline-none">
                    <div class="text-center text-sm text-gray-500 mb-2">Choose your avatar:</div>
                    <div class="avatar-picker" id="avatar-picker"></div>
                    <button onclick="Identity.createChild()" class="btn btn-primary w-full mt-4">
                        <i class="fas fa-rocket mr-2"></i>Start Adventure!
                    </button>
                    <button onclick="Identity.backToStep(1)" class="btn bg-gray-100 text-gray-600 w-full">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                </div>
            </div>

            <!-- Step 3: Enter Invite Code (For caregivers) -->
            <div id="setup-step-3" class="hidden">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">üîë</div>
                    <h2 class="text-2xl font-bold text-gray-800">Enter Invite Code</h2>
                    <p class="text-gray-500">The parent shared a code with you</p>
                </div>
                <div class="space-y-4">
                    <input type="text" id="invite-code-input" placeholder="XXXXXX" maxlength="6"
                           class="w-full p-4 border-2 border-gray-200 rounded-xl text-2xl text-center font-mono tracking-widest uppercase focus:border-purple-500 outline-none">
                    <div class="text-center text-sm text-gray-500 mb-2">What's your name?</div>
                    <input type="text" id="caregiver-name-input" placeholder="Your name..."
                           class="w-full p-4 border-2 border-gray-200 rounded-xl text-lg focus:border-purple-500 outline-none">
                    <div class="text-center text-sm text-gray-500 mb-2">Your role:</div>
                    <select id="caregiver-role-select" class="w-full p-4 border-2 border-gray-200 rounded-xl text-lg focus:border-purple-500 outline-none">
                        <option value="guardian_secondary">Co-Parent/Guardian</option>
                        <option value="healthcare_provider">Therapist/Healthcare</option>
                        <option value="educator">Teacher/Educator</option>
                        <option value="family_support">Family Member</option>
                        <option value="sibling">Sibling</option>
                    </select>
                    <button onclick="Identity.joinWithCode()" class="btn btn-primary w-full mt-4">
                        <i class="fas fa-link mr-2"></i>Connect
                    </button>
                    <button onclick="Identity.backToStep(1)" class="btn bg-gray-100 text-gray-600 w-full">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CARE TEAM MODAL -->
    <div class="modal-overlay" id="care-team-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="text-4xl mb-4">üë•</div>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Care Team</h3>

            <!-- Invite Code Section -->
            <div class="bg-purple-50 rounded-xl p-4 mb-4">
                <div class="text-sm text-purple-600 font-semibold mb-2">INVITE CODE</div>
                <div class="invite-code" id="display-invite-code">------</div>
                <div class="text-xs text-gray-500 mt-2" id="invite-code-expiry">Expires in 24 hours</div>
                <button onclick="Identity.generateInviteCode()" class="btn bg-purple-500 text-white text-sm mt-3">
                    <i class="fas fa-sync mr-1"></i>Generate New Code
                </button>
            </div>

            <!-- Connected People -->
            <div class="text-left">
                <div class="text-sm font-semibold text-gray-500 mb-2">CONNECTED</div>
                <div id="care-team-list" class="space-y-2"></div>
            </div>

            <button onclick="closeCareTeamModal()" class="btn bg-gray-200 text-gray-700 w-full mt-4">Close</button>
        </div>
    </div>

    <!-- CHILD SELECTOR MODAL (for caregivers with multiple children) -->
    <div class="modal-overlay" id="child-selector-modal">
        <div class="modal-content">
            <div class="text-4xl mb-4">üë∂</div>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Switch Child</h3>
            <div id="child-selector-list" class="space-y-2"></div>
            <button onclick="closeChildSelectorModal()" class="btn bg-gray-200 text-gray-700 w-full mt-4">Cancel</button>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// L0 KERNEL ‚Äî PURE LDS STORAGE (NO BACKEND)
// Authority: L0 Human (Armand Lefebvre)
// All data stored in localStorage as LDS entities
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const LDS = {
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // EMBEDDED LDS ENTITIES (Tasks, Achievements, Rewards, Levels)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    tasks: {
        "_lds": { "v": "1.0.0", "id": "lds:tasks/daily-v1", "type": "task.collection" },
        "categories": {
            "morning": { "icon": "sunrise", "color": "#FFB347", "tasks": [
                { "id": "wake-up", "name": "Wake Up On Time", "desc": "Get out of bed when alarm goes off", "xp": 10, "coins": 5, "icon": "bed", "time": 5 },
                { "id": "make-bed", "name": "Make Your Bed", "desc": "Pull up covers and arrange pillows", "xp": 15, "coins": 5, "icon": "bed", "time": 5 },
                { "id": "brush-am", "name": "Brush Teeth (AM)", "desc": "Brush for 2 full minutes", "xp": 15, "coins": 5, "icon": "tooth", "time": 3 },
                { "id": "get-dressed", "name": "Get Dressed", "desc": "Put on clothes for the day", "xp": 15, "coins": 5, "icon": "shirt", "time": 10 },
                { "id": "breakfast", "name": "Eat Breakfast", "desc": "Finish breakfast at the table", "xp": 20, "coins": 10, "icon": "utensils", "time": 20 },
                { "id": "pack-bag", "name": "Pack Backpack", "desc": "Check list and pack everything", "xp": 25, "coins": 10, "icon": "backpack", "time": 10 }
            ]},
            "school": { "icon": "school", "color": "#87CEEB", "tasks": [
                { "id": "stay-seated", "name": "Stay in Seat Challenge", "desc": "Stay seated for full class", "xp": 50, "coins": 25, "icon": "chair", "hero": true, "bonus": 2 },
                { "id": "raise-hand", "name": "Raise Hand First", "desc": "Raise hand instead of calling out", "xp": 40, "coins": 20, "icon": "hand", "hero": true },
                { "id": "homework-write", "name": "Write Down Homework", "desc": "Write all assignments in planner", "xp": 30, "coins": 15, "icon": "pencil" },
                { "id": "bring-home", "name": "Bring Materials Home", "desc": "Check backpack before leaving", "xp": 35, "coins": 15, "icon": "clipboard-check" }
            ]},
            "afternoon": { "icon": "sun", "color": "#98FB98", "tasks": [
                { "id": "healthy-snack", "name": "Healthy Snack", "desc": "Eat a healthy snack", "xp": 15, "coins": 5, "icon": "apple-whole", "time": 15 },
                { "id": "start-hw", "name": "Start Homework", "desc": "Begin homework within 30 min", "xp": 40, "coins": 20, "icon": "book-open", "hero": true },
                { "id": "complete-hw", "name": "Complete Homework", "desc": "Finish all assignments", "xp": 50, "coins": 25, "icon": "check-double", "hero": true, "bonus": 2 },
                { "id": "reading", "name": "Read 20 Minutes", "desc": "Read a book for 20 min", "xp": 30, "coins": 15, "icon": "book", "time": 20 }
            ]},
            "evening": { "icon": "moon", "color": "#DDA0DD", "tasks": [
                { "id": "dinner", "name": "Dinner at Table", "desc": "Eat dinner with family", "xp": 20, "coins": 10, "icon": "utensils", "time": 30 },
                { "id": "chore", "name": "Complete Daily Chore", "desc": "Do your assigned chore", "xp": 35, "coins": 20, "icon": "broom", "time": 20 },
                { "id": "screens-off", "name": "Screens Off On Time", "desc": "Turn off screens at bedtime", "xp": 45, "coins": 25, "icon": "power-off", "hero": true },
                { "id": "brush-pm", "name": "Brush Teeth (PM)", "desc": "Brush before bed", "xp": 15, "coins": 5, "icon": "tooth", "time": 3 },
                { "id": "clothes-ready", "name": "Tomorrow's Clothes", "desc": "Lay out clothes for tomorrow", "xp": 20, "coins": 10, "icon": "shirt", "time": 10 },
                { "id": "bed-time", "name": "In Bed On Time", "desc": "Be in bed by bedtime", "xp": 25, "coins": 15, "icon": "bed" }
            ]},
            "bonus": { "icon": "star", "color": "#FFD700", "tasks": [
                { "id": "help-giuliana", "name": "Help Giuliana", "desc": "Do something kind for your sister", "xp": 40, "coins": 30, "icon": "heart", "special": true, "bonus": 1.5 },
                { "id": "zero-reminders", "name": "Zero Reminders Day", "desc": "All tasks without reminders", "xp": 100, "coins": 50, "icon": "crown", "legendary": true, "bonus": 3 },
                { "id": "math-challenge", "name": "Math Challenge", "desc": "Complete a bonus math problem", "xp": 35, "coins": 20, "icon": "calculator" },
                { "id": "map-quest", "name": "Map Explorer Quest", "desc": "Learn about a new place", "xp": 30, "coins": 20, "icon": "map" }
            ]}
        }
    },

    achievements: {
        "_lds": { "v": "1.0.0", "id": "lds:achievements/badges-v1", "type": "achievement.collection" },
        "badges": [
            { "id": "first-flame", "name": "First Flame", "desc": "Complete all daily tasks for 1 day", "icon": "fire", "rarity": "common", "xp": 50, "coins": 25, "req": { "type": "streak", "val": 1 } },
            { "id": "warming-up", "name": "Warming Up", "desc": "3-day task streak", "icon": "fire", "rarity": "common", "xp": 100, "coins": 50, "req": { "type": "streak", "val": 3 } },
            { "id": "on-fire", "name": "On Fire!", "desc": "7-day task streak", "icon": "fire-flame-curved", "rarity": "uncommon", "xp": 250, "coins": 125, "req": { "type": "streak", "val": 7 } },
            { "id": "unstoppable", "name": "Unstoppable", "desc": "14-day task streak", "icon": "meteor", "rarity": "rare", "xp": 500, "coins": 300, "req": { "type": "streak", "val": 14 } },
            { "id": "legendary", "name": "Legendary Warrior", "desc": "30-day task streak", "icon": "dragon", "rarity": "legendary", "xp": 1500, "coins": 1000, "req": { "type": "streak", "val": 30 } },
            { "id": "seat-master", "name": "Seat Master", "desc": "Stay in seat 20 times", "icon": "chair", "rarity": "rare", "xp": 400, "coins": 200, "req": { "type": "task", "task": "stay-seated", "val": 20 } },
            { "id": "homework-hero", "name": "Homework Hero", "desc": "Complete homework 10 times", "icon": "book-open", "rarity": "uncommon", "xp": 250, "coins": 125, "req": { "type": "task", "task": "complete-hw", "val": 10 } },
            { "id": "kind-heart", "name": "Kind Heart", "desc": "Help Giuliana 5 times", "icon": "heart", "rarity": "uncommon", "xp": 200, "coins": 150, "req": { "type": "task", "task": "help-giuliana", "val": 5 } },
            { "id": "super-brother", "name": "Super Brother", "desc": "Help Giuliana 20 times", "icon": "heart", "rarity": "epic", "xp": 600, "coins": 400, "req": { "type": "task", "task": "help-giuliana", "val": 20 } },
            { "id": "math-wizard", "name": "Math Wizard", "desc": "Complete 50 math challenges", "icon": "hat-wizard", "rarity": "legendary", "xp": 1000, "coins": 600, "req": { "type": "task", "task": "math-challenge", "val": 50 } },
            { "id": "cartographer", "name": "Master Cartographer", "desc": "Complete 25 map quests", "icon": "map-location-dot", "rarity": "epic", "xp": 500, "coins": 350, "req": { "type": "task", "task": "map-quest", "val": 25 } },
            { "id": "level-5", "name": "Rising Star", "desc": "Reach Level 5", "icon": "star", "rarity": "common", "xp": 100, "coins": 100, "req": { "type": "level", "val": 5 } },
            { "id": "level-10", "name": "Task Champion", "desc": "Reach Level 10", "icon": "medal", "rarity": "uncommon", "xp": 300, "coins": 250, "req": { "type": "level", "val": 10 } },
            { "id": "level-25", "name": "Elite Achiever", "desc": "Reach Level 25", "icon": "trophy", "rarity": "rare", "xp": 750, "coins": 500, "req": { "type": "level", "val": 25 } },
            { "id": "level-50", "name": "Legendary Master", "desc": "Reach Level 50", "icon": "crown", "rarity": "legendary", "xp": 2000, "coins": 1500, "req": { "type": "level", "val": 50 } }
        ]
    },

    rewards: {
        "_lds": { "v": "1.0.0", "id": "lds:rewards/shop-v1", "type": "reward.shop" },
        "items": [
            { "id": "roblox-15", "name": "15 Min Roblox", "desc": "15 minutes of Roblox", "cost": 50, "icon": "gamepad", "cat": "screen" },
            { "id": "roblox-30", "name": "30 Min Roblox", "desc": "30 minutes of Roblox", "cost": 90, "icon": "gamepad", "cat": "screen" },
            { "id": "roblox-60", "name": "1 Hour Roblox", "desc": "Full hour of Roblox", "cost": 150, "icon": "gamepad", "cat": "screen" },
            { "id": "youtube-15", "name": "15 Min YouTube", "desc": "15 minutes of YouTube", "cost": 40, "icon": "play", "cat": "screen" },
            { "id": "movie-night", "name": "Movie Night Pick", "desc": "You pick family movie", "cost": 200, "icon": "film", "cat": "screen" },
            { "id": "stay-up-15", "name": "Stay Up 15 Min", "desc": "15 min past bedtime", "cost": 75, "icon": "moon", "cat": "activity" },
            { "id": "playdate", "name": "Friend Playdate", "desc": "Have a friend over", "cost": 250, "icon": "users", "cat": "activity" },
            { "id": "special-outing", "name": "Special Outing", "desc": "Trip to fun place", "cost": 400, "icon": "ticket", "cat": "activity" },
            { "id": "skip-chore", "name": "Skip One Chore", "desc": "Skip one daily chore", "cost": 100, "icon": "forward", "cat": "activity" },
            { "id": "extra-dessert", "name": "Extra Dessert", "desc": "Extra dessert treat", "cost": 60, "icon": "cookie", "cat": "treat" },
            { "id": "ice-cream", "name": "Ice Cream Trip", "desc": "Trip for ice cream", "cost": 200, "icon": "ice-cream", "cat": "treat" },
            { "id": "dinner-pick", "name": "Dinner Choice", "desc": "Pick what's for dinner", "cost": 150, "icon": "utensils", "cat": "treat" },
            { "id": "robux-100", "name": "100 Robux", "desc": "Get 100 Robux", "cost": 500, "icon": "coins", "cat": "special" },
            { "id": "new-game", "name": "New Game", "desc": "New game (under $20)", "cost": 1000, "icon": "gift", "cat": "special" },
            { "id": "sleepover", "name": "Sleepover", "desc": "Have or attend sleepover", "cost": 600, "icon": "house", "cat": "special" }
        ]
    },

    levels: {
        "_lds": { "v": "1.0.0", "id": "lds:levels/progression-v1", "type": "gamification.levels" },
        "titles": [
            { "level": 1, "title": "Beginner", "icon": "seedling" },
            { "level": 2, "title": "Apprentice", "icon": "leaf" },
            { "level": 5, "title": "Rising Star", "icon": "star" },
            { "level": 10, "title": "Champion", "icon": "medal" },
            { "level": 15, "title": "Hero", "icon": "shield" },
            { "level": 20, "title": "Master", "icon": "crown" },
            { "level": 25, "title": "Elite", "icon": "gem" },
            { "level": 30, "title": "Legendary", "icon": "dragon" },
            { "level": 50, "title": "Supreme Master", "icon": "sun" }
        ],
        "journey": [
            // HOME BASE
            { "level": 1, "place": "Jenkintown, PA", "icon": "home", "region": "home", "desc": "Home base - your journey begins!", "gem": "The town is named after William Jenkins who built a mill here in 1697!" },

            // EAST COAST ADVENTURE (Levels 2-15)
            { "level": 2, "place": "Doylestown, PA", "icon": "chess-rook", "region": "east", "desc": "Home to Fonthill Castle!", "gem": "The Mercer Museum has over 40,000 tools from the past!" },
            { "level": 3, "place": "Jim Thorpe, PA", "icon": "mountain", "region": "east", "desc": "The Switzerland of America!", "gem": "Ride a scenic train through Lehigh Gorge!" },
            { "level": 4, "place": "Cape May, NJ", "icon": "umbrella-beach", "region": "east", "desc": "Victorian beach paradise!", "gem": "Find 'Cape May Diamonds' (quartz crystals) on the beach!" },
            { "level": 5, "place": "Philadelphia, PA", "icon": "bell", "region": "east", "desc": "Home of the Liberty Bell!", "gem": "There's a 45-foot tall clothespin sculpture downtown!" },
            { "level": 6, "place": "Mystic, CT", "icon": "anchor", "region": "east", "desc": "Historic seaport town!", "gem": "Mystic Pizza from the movie is a real restaurant!" },
            { "level": 7, "place": "Salem, MA", "icon": "hat-wizard", "region": "east", "desc": "Witch trial history!", "gem": "Peabody Museum has a 200-year-old Chinese house inside!" },
            { "level": 8, "place": "Bar Harbor, ME", "icon": "tree", "region": "east", "desc": "Gateway to Acadia!", "gem": "Thunder Hole makes a booming sound when waves crash!" },
            { "level": 10, "place": "New York City, NY", "icon": "city", "region": "east", "desc": "The Big Apple!", "gem": "Secret train platform under the Waldorf Astoria hotel!" },
            { "level": 12, "place": "Sleepy Hollow, NY", "icon": "ghost", "region": "east", "desc": "Headless Horseman territory!", "gem": "Washington Irving is buried in the local cemetery!" },
            { "level": 15, "place": "Washington, DC", "icon": "landmark", "region": "east", "desc": "The nation's capital!", "gem": "Library of Congress has 838 miles of bookshelves!" },

            // SOUTHERN CHARM (Levels 16-25)
            { "level": 16, "place": "Williamsburg, VA", "icon": "scroll", "region": "south", "desc": "Colonial living museum!", "gem": "Watch blacksmiths make real horseshoes!" },
            { "level": 17, "place": "Asheville, NC", "icon": "palette", "region": "south", "desc": "Biltmore Estate awaits!", "gem": "250 rooms with secret passages and a bowling alley!" },
            { "level": 18, "place": "Charleston, SC", "icon": "horse", "region": "south", "desc": "Rainbow Row beauty!", "gem": "Haunted jail you can tour at night!" },
            { "level": 20, "place": "Savannah, GA", "icon": "tree", "region": "south", "desc": "City of beautiful squares!", "gem": "Waving Girl waved at ships for 44 years!" },
            { "level": 22, "place": "St. Augustine, FL", "icon": "fort", "region": "south", "desc": "Oldest US city (1565)!", "gem": "Fort is made of seashells that absorb cannonballs!" },
            { "level": 25, "place": "Key West, FL", "icon": "sun", "region": "south", "desc": "Closer to Cuba than Miami!", "gem": "Hemingway's house has 60 cats, many with 6 toes!" },

            // MIDWEST ADVENTURE (Levels 26-35)
            { "level": 26, "place": "Put-in-Bay, OH", "icon": "ship", "region": "midwest", "desc": "Lake Erie island fun!", "gem": "Crystal Cave has a geode big enough to walk inside!" },
            { "level": 27, "place": "Galena, IL", "icon": "building-columns", "region": "midwest", "desc": "Ulysses Grant's town!", "gem": "Toy store with over 3,000 kinds of toys!" },
            { "level": 28, "place": "Mackinac Island, MI", "icon": "horse-head", "region": "midwest", "desc": "No cars allowed!", "gem": "Grand Hotel has world's longest porch (660 feet)!" },
            { "level": 30, "place": "Duluth, MN", "icon": "water", "region": "midwest", "desc": "Gateway to Lake Superior!", "gem": "Lake Superior is so big it creates its own weather!" },
            { "level": 32, "place": "Hannibal, MO", "icon": "book", "region": "midwest", "desc": "Mark Twain's hometown!", "gem": "Explore the actual cave from Tom Sawyer!" },
            { "level": 35, "place": "Wall, SD", "icon": "store", "region": "midwest", "desc": "Wall Drug adventure!", "gem": "80-foot dinosaur and free donuts for veterans!" },

            // MOUNTAIN & DESERT WEST (Levels 36-45)
            { "level": 36, "place": "Roswell, NM", "icon": "rocket", "region": "west", "desc": "UFO capital of the world!", "gem": "Even the McDonald's is shaped like a spaceship!" },
            { "level": 37, "place": "Sedona, AZ", "icon": "mountain-sun", "region": "west", "desc": "Stunning red rocks!", "gem": "There's a chapel built INTO the red rocks!" },
            { "level": 38, "place": "Moab, UT", "icon": "archway", "region": "west", "desc": "Arches National Park!", "gem": "Over 2,000 natural stone arches!" },
            { "level": 40, "place": "Jackson Hole, WY", "icon": "mountain", "region": "west", "desc": "Elk antler arches!", "gem": "Take a ski lift UP a mountain just to eat lunch!" },
            { "level": 42, "place": "Bozeman, MT", "icon": "bone", "region": "west", "desc": "Dinosaur fossil heaven!", "gem": "Museum of the Rockies has a real T-Rex skeleton!" },
            { "level": 45, "place": "Leavenworth, WA", "icon": "snowflake", "region": "west", "desc": "Bavarian village!", "gem": "Nutcracker Museum has over 7,000 nutcrackers!" },

            // PACIFIC COAST (Levels 46-50)
            { "level": 46, "place": "Carmel-by-the-Sea, CA", "icon": "dog", "region": "pacific", "desc": "No addresses, dogs rule!", "gem": "Clint Eastwood was once the mayor!" },
            { "level": 47, "place": "Astoria, OR", "icon": "film", "region": "pacific", "desc": "The Goonies was filmed here!", "gem": "You can visit the actual Goonies house!" },
            { "level": 48, "place": "Friday Harbor, WA", "icon": "whale", "region": "pacific", "desc": "Best orca whale watching!", "gem": "The Pig War of 1859 started over a pig eating potatoes!" },
            { "level": 50, "place": "Ketchikan, AK", "icon": "fish", "region": "pacific", "desc": "Salmon Capital of the World!", "gem": "World's largest collection of totem poles!" },

            // LEGENDARY DESTINATIONS (51+)
            { "level": 55, "place": "Tombstone, AZ", "icon": "hat-cowboy", "region": "legendary", "desc": "O.K. Corral gunfight site!", "gem": "Bird Cage Theatre is one of most haunted places!" },
            { "level": 60, "place": "Whittier, AK", "icon": "building", "region": "legendary", "desc": "Everyone lives in ONE building!", "gem": "Only reachable by tunnel or boat!" },
            { "level": 75, "place": "Centralia, PA", "icon": "fire", "region": "legendary", "desc": "Underground fire since 1962!", "gem": "Steam rises from cracks in abandoned roads!" },
            { "level": 100, "place": "ANYWHERE IN THE WORLD!", "icon": "globe", "region": "legendary", "desc": "You've mastered the USA!", "gem": "Your hard work can take you anywhere!" }
        ]
    },

    profile: {
        "_lds": { "v": "1.0.0", "id": "lds:profile/armand-v1", "type": "user.profile" },
        "name": "Armand",
        "xp": 0,
        "coins": 0,
        "level": 1,
        "streak": 0,
        "longestStreak": 0,
        "screenTime": 0,
        "totalXpEarned": 0,
        "lastCompletedDate": null,
        "taskCounts": {},
        "unlockedBadges": [],
        "purchasedRewards": [],
        "todayCompleted": []
    },

    // Multi-user identity system
    identities: {
        "_lds": { "v": "1.0.0", "id": "lds:identities/store-v1", "type": "identity.store" },
        "children": [],      // Array of child profiles
        "caregivers": [],    // Array of caregiver profiles
        "connections": [],   // Links between caregivers and children
        "inviteCodes": {}    // Active invite codes
    }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// L1 ABYSS ‚Äî PERSISTENCE (localStorage)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Storage = {
    PROFILE_KEY: 'tq_profile_v1',
    IDENTITY_KEY: 'tq_identities_v1',
    SESSION_KEY: 'tq_session_v1',

    load() {
        // Load profile
        const saved = localStorage.getItem(this.PROFILE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            Object.assign(LDS.profile, data);
        }
        // Load identities
        const identities = localStorage.getItem(this.IDENTITY_KEY);
        if (identities) {
            const data = JSON.parse(identities);
            Object.assign(LDS.identities, data);
        }
        return LDS.profile;
    },

    save() {
        localStorage.setItem(this.PROFILE_KEY, JSON.stringify(LDS.profile));
    },

    saveIdentities() {
        localStorage.setItem(this.IDENTITY_KEY, JSON.stringify(LDS.identities));
    },

    saveSession(session) {
        localStorage.setItem(this.SESSION_KEY, JSON.stringify(session));
    },

    getSession() {
        const s = localStorage.getItem(this.SESSION_KEY);
        return s ? JSON.parse(s) : null;
    },

    reset() {
        if (confirm('Reset ALL progress? This cannot be undone!')) {
            localStorage.removeItem(this.PROFILE_KEY);
            location.reload();
        }
    }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// IDENTITY SYSTEM ‚Äî Multi-user support
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Identity = {
    avatars: ['üêâ', 'ü¶Å', 'üê∫', 'ü¶Ö', 'ü¶ä', 'üêª', 'ü¶Ñ', 'üê≤', 'ü¶à', 'üêô', 'ü¶ã', 'üåü', '‚ö°', 'üî•', 'üíé', 'üåà'],
    selectedAvatar: 'üêâ',
    selectedRole: null,
    currentChildId: null,
    currentUserId: null,
    currentUserRole: null,

    // Check if first-time setup needed
    needsSetup() {
        const session = Storage.getSession();
        if (session && session.userId) {
            // Restore session
            this.currentUserId = session.userId;
            this.currentUserRole = session.role;
            this.currentChildId = session.childId;
            return false;
        }
        // Check if any identities exist
        return LDS.identities.children.length === 0 && LDS.identities.caregivers.length === 0;
    },

    // Show setup screen
    showSetup() {
        document.getElementById('setup-screen').classList.remove('hidden');
        this.renderAvatarPicker();
    },

    hideSetup() {
        document.getElementById('setup-screen').classList.add('hidden');
    },

    renderAvatarPicker() {
        const container = document.getElementById('avatar-picker');
        container.innerHTML = this.avatars.map(a =>
            `<div class="avatar-option ${a === this.selectedAvatar ? 'selected' : ''}" onclick="Identity.selectAvatar('${a}')">${a}</div>`
        ).join('');
    },

    selectAvatar(avatar) {
        this.selectedAvatar = avatar;
        this.renderAvatarPicker();
    },

    selectRole(role) {
        this.selectedRole = role;
        document.getElementById('setup-step-1').classList.add('hidden');

        if (role === 'child' || role === 'guardian_primary') {
            document.getElementById('setup-step-2').classList.remove('hidden');
        } else if (role === 'caregiver') {
            document.getElementById('setup-step-3').classList.remove('hidden');
        }
    },

    backToStep(step) {
        document.querySelectorAll('[id^="setup-step-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(`setup-step-${step}`).classList.remove('hidden');
    },

    // Generate unique IDs
    generateId(prefix) {
        return `${prefix}-${Date.now().toString(36)}-${Math.random().toString(36).substr(2, 6)}`;
    },

    generateInviteCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // No confusing chars
        let code = '';
        for (let i = 0; i < 6; i++) {
            code += chars[Math.floor(Math.random() * chars.length)];
        }

        // Store invite code
        const expires = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();
        LDS.identities.inviteCodes[code] = {
            childId: this.currentChildId,
            createdBy: this.currentUserId,
            expires: expires
        };
        Storage.saveIdentities();

        // Update display
        document.getElementById('display-invite-code').textContent = code;
        document.getElementById('invite-code-expiry').textContent = 'Expires in 24 hours';

        return code;
    },

    // Create new child profile
    createChild() {
        const name = document.getElementById('child-name-input').value.trim();
        if (!name) {
            alert('Please enter a name!');
            return;
        }

        const childId = this.generateId('c');
        const child = {
            childId: childId,
            name: name,
            avatar: this.selectedAvatar,
            createdAt: new Date().toISOString(),
            profile: {
                xp: 0, coins: 0, level: 1, streak: 0, longestStreak: 0,
                screenTime: 0, totalXpEarned: 0, lastCompletedDate: null,
                taskCounts: {}, unlockedBadges: [], purchasedRewards: [], todayCompleted: []
            }
        };

        LDS.identities.children.push(child);

        // If guardian_primary, create caregiver too
        if (this.selectedRole === 'guardian_primary') {
            const caregiverId = this.generateId('cg');
            const caregiver = {
                caregiverId: caregiverId,
                name: 'Parent', // Can be updated later
                role: 'guardian_primary',
                createdAt: new Date().toISOString()
            };
            LDS.identities.caregivers.push(caregiver);

            // Create connection
            LDS.identities.connections.push({
                connectionId: this.generateId('conn'),
                childId: childId,
                caregiverId: caregiverId,
                role: 'guardian_primary',
                connectedAt: new Date().toISOString()
            });

            this.currentUserId = caregiverId;
            this.currentUserRole = 'guardian_primary';
        } else {
            // Child is using the app directly
            this.currentUserId = childId;
            this.currentUserRole = 'child';
        }

        this.currentChildId = childId;

        // Save everything
        Storage.saveIdentities();
        Storage.saveSession({
            userId: this.currentUserId,
            role: this.currentUserRole,
            childId: this.currentChildId
        });

        // Copy child profile to active profile
        Object.assign(LDS.profile, child.profile, { name: child.name });
        Storage.save();

        this.hideSetup();
        UI.render();
    },

    // Join with invite code
    joinWithCode() {
        const code = document.getElementById('invite-code-input').value.trim().toUpperCase();
        const name = document.getElementById('caregiver-name-input').value.trim();
        const role = document.getElementById('caregiver-role-select').value;

        if (!code || code.length !== 6) {
            alert('Please enter a valid 6-character invite code');
            return;
        }
        if (!name) {
            alert('Please enter your name');
            return;
        }

        // Validate invite code
        const invite = LDS.identities.inviteCodes[code];
        if (!invite) {
            alert('Invalid invite code. Please check with the parent.');
            return;
        }
        if (new Date(invite.expires) < new Date()) {
            alert('This invite code has expired. Please ask for a new one.');
            delete LDS.identities.inviteCodes[code];
            Storage.saveIdentities();
            return;
        }

        // Create caregiver
        const caregiverId = this.generateId('cg');
        const caregiver = {
            caregiverId: caregiverId,
            name: name,
            role: role,
            createdAt: new Date().toISOString()
        };
        LDS.identities.caregivers.push(caregiver);

        // Create connection
        LDS.identities.connections.push({
            connectionId: this.generateId('conn'),
            childId: invite.childId,
            caregiverId: caregiverId,
            role: role,
            connectedAt: new Date().toISOString(),
            invitedBy: invite.createdBy
        });

        // Delete used invite code
        delete LDS.identities.inviteCodes[code];

        this.currentUserId = caregiverId;
        this.currentUserRole = role;
        this.currentChildId = invite.childId;

        Storage.saveIdentities();
        Storage.saveSession({
            userId: this.currentUserId,
            role: this.currentUserRole,
            childId: this.currentChildId
        });

        // Load child's profile
        const child = LDS.identities.children.find(c => c.childId === invite.childId);
        if (child) {
            Object.assign(LDS.profile, child.profile, { name: child.name });
        }

        this.hideSetup();
        UI.render();
        alert(`Welcome, ${name}! You're now connected to ${child?.name || 'the child'}'s Task Quest.`);
    },

    // Get current child
    getCurrentChild() {
        return LDS.identities.children.find(c => c.childId === this.currentChildId);
    },

    // Get connected caregivers for current child
    getConnectedCaregivers() {
        const connections = LDS.identities.connections.filter(c => c.childId === this.currentChildId);
        return connections.map(conn => {
            const caregiver = LDS.identities.caregivers.find(cg => cg.caregiverId === conn.caregiverId);
            return { ...caregiver, connectionRole: conn.role };
        }).filter(Boolean);
    },

    // Get children connected to current caregiver
    getConnectedChildren() {
        const connections = LDS.identities.connections.filter(c => c.caregiverId === this.currentUserId);
        return connections.map(conn => {
            const child = LDS.identities.children.find(ch => ch.childId === conn.childId);
            return { ...child, connectionRole: conn.role };
        }).filter(Boolean);
    },

    // Switch to different child (for caregivers with multiple children)
    switchChild(childId) {
        const child = LDS.identities.children.find(c => c.childId === childId);
        if (!child) return;

        this.currentChildId = childId;

        // Update session
        Storage.saveSession({
            userId: this.currentUserId,
            role: this.currentUserRole,
            childId: this.currentChildId
        });

        // Load child's profile
        Object.assign(LDS.profile, child.profile, { name: child.name });
        UI.render();
        closeChildSelectorModal();
    },

    // Sync profile back to child record
    syncProfile() {
        const child = this.getCurrentChild();
        if (child) {
            child.profile = {
                xp: LDS.profile.xp,
                coins: LDS.profile.coins,
                level: LDS.profile.level,
                streak: LDS.profile.streak,
                longestStreak: LDS.profile.longestStreak,
                screenTime: LDS.profile.screenTime,
                totalXpEarned: LDS.profile.totalXpEarned,
                lastCompletedDate: LDS.profile.lastCompletedDate,
                taskCounts: LDS.profile.taskCounts,
                unlockedBadges: LDS.profile.unlockedBadges,
                purchasedRewards: LDS.profile.purchasedRewards,
                todayCompleted: LDS.profile.todayCompleted
            };
            Storage.saveIdentities();
        }
    },

    // Role-based permission check
    canDo(action) {
        const permissions = {
            child: ['complete_tasks', 'view_own_progress', 'purchase_rewards', 'view_journey'],
            guardian_primary: ['all'],
            guardian_secondary: ['complete_tasks', 'view_progress', 'manage_rewards', 'verify_tasks', 'add_tasks'],
            healthcare_provider: ['view_progress', 'add_therapeutic_tasks', 'add_notes'],
            educator: ['verify_school_tasks', 'view_school_progress', 'add_school_tasks'],
            family_support: ['verify_tasks', 'send_encouragement', 'view_progress'],
            sibling: ['view_shared', 'send_encouragement']
        };

        const myPerms = permissions[this.currentUserRole] || [];
        return myPerms.includes('all') || myPerms.includes(action);
    },

    // Get role display info
    getRoleInfo(role) {
        const info = {
            guardian_primary: { label: 'Parent', color: 'bg-purple-500', icon: 'üëë' },
            guardian_secondary: { label: 'Co-Parent', color: 'bg-purple-400', icon: 'üë®‚Äçüë©‚Äçüëß' },
            healthcare_provider: { label: 'Therapist', color: 'bg-blue-500', icon: 'ü©∫' },
            educator: { label: 'Teacher', color: 'bg-green-500', icon: 'üìö' },
            family_support: { label: 'Family', color: 'bg-orange-500', icon: '‚ù§Ô∏è' },
            sibling: { label: 'Sibling', color: 'bg-pink-500', icon: 'üë´' },
            child: { label: 'Hero', color: 'bg-yellow-500', icon: '‚≠ê' }
        };
        return info[role] || { label: role, color: 'bg-gray-500', icon: 'üë§' };
    }
};

// Care Team Modal Functions
function openCareTeamModal() {
    const modal = document.getElementById('care-team-modal');
    modal.classList.add('active');

    // Generate initial code if none exists
    const codes = Object.keys(LDS.identities.inviteCodes);
    const validCode = codes.find(c => {
        const invite = LDS.identities.inviteCodes[c];
        return invite.childId === Identity.currentChildId && new Date(invite.expires) > new Date();
    });

    if (validCode) {
        document.getElementById('display-invite-code').textContent = validCode;
        const expires = new Date(LDS.identities.inviteCodes[validCode].expires);
        const hoursLeft = Math.round((expires - new Date()) / (1000 * 60 * 60));
        document.getElementById('invite-code-expiry').textContent = `Expires in ${hoursLeft} hours`;
    } else {
        document.getElementById('display-invite-code').textContent = '------';
        document.getElementById('invite-code-expiry').textContent = 'Click to generate';
    }

    // Render connected caregivers
    const caregivers = Identity.getConnectedCaregivers();
    const list = document.getElementById('care-team-list');
    if (caregivers.length === 0) {
        list.innerHTML = '<div class="text-gray-400 text-sm">No one else connected yet</div>';
    } else {
        list.innerHTML = caregivers.map(cg => {
            const info = Identity.getRoleInfo(cg.connectionRole);
            return `
                <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg">
                    <span class="text-2xl">${info.icon}</span>
                    <div class="flex-1">
                        <div class="font-semibold">${cg.name}</div>
                        <span class="care-team-badge ${info.color} text-white">${info.label}</span>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function closeCareTeamModal() {
    document.getElementById('care-team-modal').classList.remove('active');
}

function openChildSelectorModal() {
    const children = Identity.getConnectedChildren();
    const list = document.getElementById('child-selector-list');

    list.innerHTML = children.map(child => `
        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 ${child.childId === Identity.currentChildId ? 'ring-2 ring-purple-500' : ''}"
             onclick="Identity.switchChild('${child.childId}')">
            <span class="text-3xl">${child.avatar}</span>
            <div class="flex-1">
                <div class="font-bold">${child.name}</div>
                <div class="text-sm text-gray-500">Level ${child.profile.level}</div>
            </div>
            ${child.childId === Identity.currentChildId ? '<i class="fas fa-check text-purple-500"></i>' : ''}
        </div>
    `).join('');

    document.getElementById('child-selector-modal').classList.add('active');
}

function closeChildSelectorModal() {
    document.getElementById('child-selector-modal').classList.remove('active');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// L2 DEEP ‚Äî KNOWLEDGE (XP Calculations)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Knowledge = {
    xpForLevel(level) {
        return Math.floor(100 * level * 1.2);
    },

    getTitle(level) {
        let title = LDS.levels.titles[0];
        for (const t of LDS.levels.titles) {
            if (level >= t.level) title = t;
        }
        return title;
    },

    getAllTasks() {
        const tasks = [];
        for (const [catId, cat] of Object.entries(LDS.tasks.categories)) {
            for (const task of cat.tasks) {
                tasks.push({ ...task, category: catId, categoryIcon: cat.icon, categoryColor: cat.color });
            }
        }
        return tasks;
    },

    getTaskCount(taskId) {
        return LDS.profile.taskCounts[taskId] || 0;
    },

    checkAchievements() {
        const newBadges = [];
        for (const badge of LDS.achievements.badges) {
            if (LDS.profile.unlockedBadges.includes(badge.id)) continue;

            let earned = false;
            const req = badge.req;

            if (req.type === 'streak' && LDS.profile.streak >= req.val) earned = true;
            if (req.type === 'level' && LDS.profile.level >= req.val) earned = true;
            if (req.type === 'task' && this.getTaskCount(req.task) >= req.val) earned = true;

            if (earned) {
                LDS.profile.unlockedBadges.push(badge.id);
                LDS.profile.xp += badge.xp;
                LDS.profile.coins += badge.coins;
                newBadges.push(badge);
            }
        }
        return newBadges;
    }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// L3 THERMOCLINE ‚Äî CONTEXT (Session State)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Context = {
    today: new Date().toISOString().split('T')[0],

    isTaskDoneToday(taskId) {
        return LDS.profile.todayCompleted.includes(taskId);
    },

    resetIfNewDay() {
        if (LDS.profile.lastCompletedDate !== this.today) {
            // Check if streak continues or breaks
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (LDS.profile.lastCompletedDate !== yesterdayStr && LDS.profile.lastCompletedDate !== null) {
                LDS.profile.streak = 0; // Streak broken
            }

            LDS.profile.todayCompleted = [];
        }
    }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// L4 CURRENT ‚Äî ACTIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Actions = {
    completeTask(taskId) {
        if (Context.isTaskDoneToday(taskId)) return;

        const tasks = Knowledge.getAllTasks();
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;

        // Calculate XP/coins with bonus multiplier
        const bonus = task.bonus || 1;
        const xpGain = Math.floor(task.xp * bonus);
        const coinGain = Math.floor(task.coins * bonus);

        // Award XP and coins
        LDS.profile.xp += xpGain;
        LDS.profile.coins += coinGain;
        LDS.profile.totalXpEarned = (LDS.profile.totalXpEarned || 0) + xpGain;

        // üéÆ SCREEN TIME: 10 XP = 1 minute
        const screenTimeEarned = Math.floor(xpGain / 10);
        LDS.profile.screenTime = (LDS.profile.screenTime || 0) + screenTimeEarned;

        LDS.profile.todayCompleted.push(taskId);
        LDS.profile.lastCompletedDate = Context.today;

        // Track task count for achievements
        LDS.profile.taskCounts[taskId] = (LDS.profile.taskCounts[taskId] || 0) + 1;

        // Check level up
        this.checkLevelUp();

        // Check streak
        const allTasks = Knowledge.getAllTasks();
        const requiredTasks = allTasks.filter(t => !t.special && !t.legendary);
        const completedRequired = requiredTasks.filter(t => Context.isTaskDoneToday(t.id)).length;

        if (completedRequired >= Math.floor(requiredTasks.length * 0.8)) {
            if (!LDS.profile._streakIncrementedToday) {
                LDS.profile.streak++;
                LDS.profile._streakIncrementedToday = true;
                if (LDS.profile.streak > LDS.profile.longestStreak) {
                    LDS.profile.longestStreak = LDS.profile.streak;
                }
            }
        }

        // Check achievements
        const newBadges = Knowledge.checkAchievements();
        this.checkLevelUp(); // Re-check after achievement XP

        Storage.save();
        UI.render();
        UI.celebrate(task, xpGain, screenTimeEarned);

        for (const badge of newBadges) {
            setTimeout(() => UI.showBadgeUnlock(badge), 1000);
        }
    },

    checkLevelUp() {
        let leveled = false;
        while (LDS.profile.xp >= Knowledge.xpForLevel(LDS.profile.level)) {
            LDS.profile.xp -= Knowledge.xpForLevel(LDS.profile.level);
            LDS.profile.level++;
            leveled = true;
        }
        if (leveled) {
            setTimeout(() => UI.showLevelUp(), 500);
        }
    },

    purchaseReward(rewardId) {
        const reward = LDS.rewards.items.find(r => r.id === rewardId);
        if (!reward || LDS.profile.coins < reward.cost) return false;

        LDS.profile.coins -= reward.cost;
        LDS.profile.purchasedRewards.push({ id: rewardId, date: new Date().toISOString() });
        Storage.save();
        UI.render();
        UI.showPurchase(reward);
        return true;
    }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// L5 SURFACE ‚Äî UI RENDERING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const UI = {
    render() {
        this.renderHeader();
        this.renderTasks();
        this.renderShop();
        this.renderBadges();
        this.renderJourney();
    },

    renderHeader() {
        const p = LDS.profile;
        const title = Knowledge.getTitle(p.level);
        const xpNeeded = Knowledge.xpForLevel(p.level);
        const xpPercent = (p.xp / xpNeeded) * 100;

        document.getElementById('hero-name').textContent = p.name;
        document.getElementById('hero-level').textContent = `Level ${p.level}`;
        document.getElementById('hero-title').textContent = title.title;
        document.getElementById('hero-coins').textContent = p.coins;
        document.getElementById('hero-streak').textContent = p.streak;
        document.getElementById('hero-screentime').textContent = p.screenTime || 0;
        document.getElementById('xp-current').textContent = `${p.xp} XP`;
        document.getElementById('xp-next').textContent = `${xpNeeded} XP to Level ${p.level + 1}`;
        document.getElementById('xp-bar').style.width = `${xpPercent}%`;

        // Make screen time clickable to redeem
        const screenEl = document.getElementById('hero-screentime').parentElement;
        screenEl.style.cursor = p.screenTime > 0 ? 'pointer' : 'default';
        screenEl.onclick = p.screenTime > 0 ? () => openRedeemModal() : null;

        // Identity-related UI updates
        const child = Identity.getCurrentChild();
        if (child) {
            document.getElementById('hero-avatar').textContent = child.avatar;
        }

        // Show role badge for non-child users
        const roleBadge = document.getElementById('role-badge');
        if (Identity.currentUserRole && Identity.currentUserRole !== 'child') {
            const roleInfo = Identity.getRoleInfo(Identity.currentUserRole);
            roleBadge.textContent = roleInfo.label;
            roleBadge.classList.remove('hidden');
        } else {
            roleBadge.classList.add('hidden');
        }

        // Show care team button for guardians
        const careTeamBtn = document.getElementById('care-team-btn');
        if (Identity.canDo('all') || Identity.currentUserRole === 'guardian_secondary') {
            careTeamBtn.classList.remove('hidden');
        } else {
            careTeamBtn.classList.add('hidden');
        }
    },

    renderTasks() {
        const container = document.getElementById('task-list');
        const tasks = Knowledge.getAllTasks();
        let completed = 0;

        let html = '';
        let currentCat = '';

        for (const task of tasks) {
            const done = Context.isTaskDoneToday(task.id);
            if (done) completed++;

            if (task.category !== currentCat) {
                currentCat = task.category;
                const cat = LDS.tasks.categories[currentCat];
                html += `<div class="text-sm font-semibold text-gray-500 mt-4 mb-2 flex items-center gap-2">
                    <i class="fas fa-${cat.icon}" style="color: ${cat.color}"></i> ${currentCat.charAt(0).toUpperCase() + currentCat.slice(1)}
                </div>`;
            }

            const heroClass = task.hero ? 'hero-task' : '';
            const specialClass = task.special ? 'border-l-4 border-pink-500' : '';
            const legendaryClass = task.legendary ? 'legendary-task' : '';

            // Calculate actual XP with bonus
            const bonus = task.bonus || 1;
            const actualXp = Math.floor(task.xp * bonus);
            const actualCoins = Math.floor(task.coins * bonus);
            const screenTimePreview = Math.floor(actualXp / 10);

            // Bonus badge
            let bonusBadge = '';
            if (task.legendary) {
                bonusBadge = '<span class="text-xs bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-2 py-0.5 rounded-full ml-1">üëë 3x</span>';
            } else if (task.hero && task.bonus >= 2) {
                bonusBadge = '<span class="text-xs bg-purple-500 text-white px-2 py-0.5 rounded-full ml-1">‚öîÔ∏è 2x</span>';
            } else if (task.hero) {
                bonusBadge = '<span class="text-xs bg-purple-400 text-white px-2 py-0.5 rounded-full ml-1">‚≠ê Hero</span>';
            }

            // Time limit badge
            let timeBadge = '';
            if (task.time) {
                timeBadge = `<span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full"><i class="fas fa-clock mr-1"></i>${task.time}m</span>`;
            }

            html += `
                <div class="task-card card p-4 ${done ? 'done' : ''} ${heroClass} ${specialClass} ${legendaryClass}"
                     onclick="${done ? '' : `Actions.completeTask('${task.id}')`}">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${done ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'}">
                            <i class="fas fa-${done ? 'check' : task.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold ${done ? 'line-through text-gray-400' : 'text-gray-800'}">
                                ${task.name}${bonusBadge}
                            </div>
                            <div class="text-sm text-gray-500 flex items-center gap-2">
                                ${task.desc}
                                ${timeBadge}
                            </div>
                        </div>
                        <div class="text-right text-sm">
                            <div class="text-blue-600 font-semibold">+${actualXp} XP</div>
                            <div class="text-yellow-600">+${actualCoins} <i class="fas fa-coins"></i></div>
                            <div class="text-green-500 text-xs">+${screenTimePreview}m <i class="fas fa-tv"></i></div>
                        </div>
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
        document.getElementById('tasks-progress').textContent = `${completed}/${tasks.length} Complete`;
    },

    renderShop() {
        const container = document.getElementById('shop-list');
        let html = '';

        for (const item of LDS.rewards.items) {
            const canAfford = LDS.profile.coins >= item.cost;

            html += `
                <div class="card p-4 ${canAfford ? 'cursor-pointer hover:shadow-lg' : 'opacity-50'}"
                     onclick="${canAfford ? `Actions.purchaseReward('${item.id}')` : ''}">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xl">
                            <i class="fas fa-${item.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">${item.name}</div>
                            <div class="text-sm text-gray-500">${item.desc}</div>
                        </div>
                        <div class="text-lg font-bold ${canAfford ? 'text-yellow-600' : 'text-gray-400'}">
                            ${item.cost} <i class="fas fa-coins"></i>
                        </div>
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
    },

    renderBadges() {
        const container = document.getElementById('badge-list');
        let html = '';

        const rarityColors = {
            common: 'bg-gray-100 text-gray-600',
            uncommon: 'bg-green-100 text-green-600',
            rare: 'bg-blue-100 text-blue-600',
            epic: 'bg-purple-100 text-purple-600',
            legendary: 'bg-yellow-100 text-yellow-600'
        };

        for (const badge of LDS.achievements.badges) {
            const unlocked = LDS.profile.unlockedBadges.includes(badge.id);
            const colors = rarityColors[badge.rarity];

            html += `
                <div class="card p-4 ${unlocked ? '' : 'opacity-40 grayscale'}">
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto rounded-full ${colors} flex items-center justify-center text-2xl mb-2">
                            <i class="fas fa-${badge.icon}"></i>
                        </div>
                        <div class="font-semibold text-sm">${badge.name}</div>
                        <div class="text-xs text-gray-500 mt-1">${badge.desc}</div>
                        ${unlocked ? '<div class="text-xs text-green-600 mt-2"><i class="fas fa-check"></i> Unlocked</div>' : ''}
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
    },

    renderJourney() {
        const container = document.getElementById('journey-list');
        let html = '';
        let currentRegion = '';

        const regionColors = {
            home: 'bg-purple-500', east: 'bg-blue-500', south: 'bg-green-500',
            midwest: 'bg-yellow-500', west: 'bg-orange-500', pacific: 'bg-cyan-500', legendary: 'bg-red-500'
        };
        const regionNames = {
            home: 'Home Base', east: 'East Coast Adventure', south: 'Southern Charm',
            midwest: 'Midwest Adventure', west: 'Mountain & Desert West', pacific: 'Pacific Coast', legendary: 'Legendary Destinations'
        };

        for (const m of LDS.levels.journey) {
            const reached = LDS.profile.level >= m.level;
            const isNext = !reached && LDS.profile.level === m.level - 1;
            const regionColor = regionColors[m.region] || 'bg-gray-500';

            // Region header
            if (m.region !== currentRegion) {
                currentRegion = m.region;
                html += `<div class="text-sm font-bold text-gray-500 mt-6 mb-2 flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full ${regionColor}"></span> ${regionNames[m.region] || m.region}
                </div>`;
            }

            html += `
                <div class="card p-4 ${reached ? '' : isNext ? 'ring-2 ring-purple-400' : 'opacity-40'} ${isNext ? 'bg-purple-50' : ''}">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-full ${reached ? regionColor + ' text-white' : 'bg-gray-200 text-gray-400'} flex items-center justify-center text-xl">
                            <i class="fas fa-${m.icon || 'map-marker-alt'}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold ${reached ? 'text-green-600' : 'text-gray-400'}">LVL ${m.level}</span>
                                ${reached ? '<i class="fas fa-check-circle text-green-500 text-xs"></i>' : ''}
                                ${isNext ? '<span class="text-xs bg-purple-500 text-white px-2 py-0.5 rounded-full">NEXT</span>' : ''}
                            </div>
                            <div class="font-bold ${reached ? 'text-gray-800' : 'text-gray-500'}">${m.place}</div>
                            <div class="text-sm text-gray-500">${m.desc}</div>
                            ${reached && m.gem ? `<div class="text-xs text-purple-600 mt-1"><i class="fas fa-gem mr-1"></i>${m.gem}</div>` : ''}
                        </div>
                        ${reached ? '<i class="fas fa-map-marker-alt text-2xl text-green-500"></i>' : '<i class="fas fa-lock text-gray-300"></i>'}
                    </div>
                </div>
            `;
        }

        // Summary
        const totalCities = LDS.levels.journey.length;
        const unlockedCities = LDS.levels.journey.filter(m => LDS.profile.level >= m.level).length;
        html = `<div class="text-center mb-4 p-3 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-xl">
            <div class="text-2xl font-bold">${unlockedCities} / ${totalCities}</div>
            <div class="text-sm opacity-90">Cities Unlocked</div>
        </div>` + html;

        container.innerHTML = html;
    },

    celebrate(task, xpGain, screenTimeEarned) {
        // Confetti - more for hero/legendary tasks
        const emojis = task.legendary ? ['üëë', 'üíé', 'üåü', '‚ú®', 'üî•', 'üèÜ'] :
                       task.hero ? ['‚≠ê', '‚öîÔ∏è', 'üî•', 'üí™', 'üéØ', '‚ú®'] :
                       ['üéâ', '‚≠ê', 'üî•', 'üíé', 'üèÜ', '‚ú®'];
        const confettiCount = task.legendary ? 30 : task.hero ? 20 : 15;

        for (let i = 0; i < confettiCount; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.animationDelay = Math.random() * 0.5 + 's';
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 3500);
        }

        // Sound feedback with screen time announcement
        if ('speechSynthesis' in window) {
            let message = `Great job! Plus ${xpGain} XP!`;
            if (screenTimeEarned > 0) {
                message += ` You earned ${screenTimeEarned} minutes of screen time!`;
            }
            if (task.legendary) {
                message = `Legendary achievement! ${message}`;
            } else if (task.hero) {
                message = `Hero task complete! ${message}`;
            }
            const msg = new SpeechSynthesisUtterance(message);
            msg.rate = 1.1;
            msg.pitch = 1.2;
            speechSynthesis.speak(msg);
        }
    },

    showBadgeUnlock(badge) {
        alert(`üèÜ ACHIEVEMENT UNLOCKED!\n\n${badge.name}\n${badge.desc}\n\n+${badge.xp} XP  +${badge.coins} Coins`);
    },

    showLevelUp() {
        const title = Knowledge.getTitle(LDS.profile.level);
        alert(`üéâ LEVEL UP!\n\nYou are now Level ${LDS.profile.level}!\n"${title.title}"`);
    },

    showPurchase(reward) {
        alert(`üõí Purchased!\n\n${reward.name}\n\nGo tell Mom or Dad to redeem your reward!`);
    }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TIMER SYSTEM ‚Äî For timed tasks
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Timer = {
    currentTask: null,
    interval: null,
    secondsRemaining: 0,

    start(taskId) {
        const tasks = Knowledge.getAllTasks();
        const task = tasks.find(t => t.id === taskId);
        if (!task || !task.time) return;

        this.currentTask = task;
        this.secondsRemaining = task.time * 60;

        const bonus = task.bonus || 1;
        const xpGain = Math.floor(task.xp * bonus);
        const screenTime = Math.floor(xpGain / 10);

        document.getElementById('timer-task-name').textContent = task.name;
        document.getElementById('timer-xp-preview').textContent = `+${xpGain} XP ‚Ä¢ +${screenTime} min screen time`;
        document.getElementById('timer-modal').classList.add('active');

        this.updateDisplay();
        this.interval = setInterval(() => this.tick(), 1000);
    },

    tick() {
        this.secondsRemaining--;
        this.updateDisplay();

        if (this.secondsRemaining <= 0) {
            this.complete();
        }
    },

    updateDisplay() {
        const mins = Math.floor(this.secondsRemaining / 60);
        const secs = this.secondsRemaining % 60;
        const display = `${mins}:${secs.toString().padStart(2, '0')}`;
        document.getElementById('timer-display').textContent = display;

        // Pulse when under 30 seconds
        const displayEl = document.getElementById('timer-display');
        if (this.secondsRemaining <= 30 && this.secondsRemaining > 0) {
            displayEl.classList.add('timer-active');
            displayEl.style.color = '#ef4444';
        } else {
            displayEl.classList.remove('timer-active');
            displayEl.style.color = '';
        }
    },

    cancel() {
        clearInterval(this.interval);
        this.currentTask = null;
        document.getElementById('timer-modal').classList.remove('active');
    },

    complete() {
        clearInterval(this.interval);
        document.getElementById('timer-modal').classList.remove('active');

        if (this.currentTask) {
            Actions.completeTask(this.currentTask.id);
        }
        this.currentTask = null;
    }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SCREEN TIME REDEMPTION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let screenTimeCountdown = null;

function openRedeemModal() {
    const screenTime = LDS.profile.screenTime || 0;
    if (screenTime <= 0) return;

    document.getElementById('redeem-amount').textContent = `${screenTime} min`;
    document.getElementById('redeem-modal').classList.add('active');
}

function closeRedeemModal() {
    document.getElementById('redeem-modal').classList.remove('active');
}

function useScreenTime() {
    const screenTime = LDS.profile.screenTime || 0;
    if (screenTime <= 0) return;

    // Set screen time to 0 after use
    LDS.profile.screenTime = 0;
    Storage.save();
    UI.render();

    closeRedeemModal();

    // Start countdown display
    startScreenTimeCountdown(screenTime);
}

function startScreenTimeCountdown(minutes) {
    let secondsRemaining = minutes * 60;

    // Create floating timer
    const timerEl = document.createElement('div');
    timerEl.id = 'screen-time-countdown';
    timerEl.className = 'fixed bottom-4 right-4 bg-green-500 text-white rounded-2xl px-6 py-4 shadow-xl z-50';
    timerEl.innerHTML = `
        <div class="text-center">
            <div class="text-xs opacity-80">SCREEN TIME</div>
            <div class="text-3xl font-bold font-mono" id="countdown-display">${minutes}:00</div>
            <button onclick="cancelScreenTime()" class="text-xs mt-1 opacity-80 hover:opacity-100">Cancel</button>
        </div>
    `;
    document.body.appendChild(timerEl);

    screenTimeCountdown = setInterval(() => {
        secondsRemaining--;
        const mins = Math.floor(secondsRemaining / 60);
        const secs = secondsRemaining % 60;
        document.getElementById('countdown-display').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

        if (secondsRemaining <= 60) {
            timerEl.classList.remove('bg-green-500');
            timerEl.classList.add('bg-orange-500');
        }
        if (secondsRemaining <= 0) {
            clearInterval(screenTimeCountdown);
            timerEl.classList.remove('bg-orange-500');
            timerEl.classList.add('bg-red-500');
            document.getElementById('countdown-display').textContent = "TIME'S UP!";

            // Announce time's up
            if ('speechSynthesis' in window) {
                const msg = new SpeechSynthesisUtterance('Screen time is over!');
                msg.rate = 1.0;
                speechSynthesis.speak(msg);
            }

            setTimeout(() => timerEl.remove(), 5000);
        }
    }, 1000);
}

function cancelScreenTime() {
    if (screenTimeCountdown) {
        clearInterval(screenTimeCountdown);
        const el = document.getElementById('screen-time-countdown');
        if (el) el.remove();
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB NAVIGATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(tab) {
    ['tasks', 'shop', 'badges', 'journey'].forEach(t => {
        document.getElementById(`tab-${t}`).classList.toggle('hidden', t !== tab);
        document.querySelector(`[data-tab="${t}"]`).classList.toggle('active', t === tab);
    });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INIT ‚Äî APP STARTUP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
    Storage.load();

    // Check if first-time setup needed
    if (Identity.needsSetup()) {
        Identity.showSetup();
        return;
    }

    // Load the correct child's profile if we have a session
    const child = Identity.getCurrentChild();
    if (child) {
        Object.assign(LDS.profile, child.profile, { name: child.name });
    }

    Context.resetIfNewDay();
    UI.render();
}

// Override Storage.save to sync back to child record
const originalSave = Storage.save.bind(Storage);
Storage.save = function() {
    originalSave();
    Identity.syncProfile();
};

// Service Worker Registration
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// Start App
init();
</script>
</body>
</html>
